import React, { useState } from 'react';
import { Link as RouterLink, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext.jsx';
import { useNotification } from '../context/NotificationContext.jsx';
import { KVKK_TEXTS } from '../constants/kvkkTexts';

// MUI Imports
import Avatar from '@mui/material/Avatar';
import Button from '@mui/material/Button';
import TextField from '@mui/material/TextField';
import Link from '@mui/material/Link';
import Grid from '@mui/material/Grid';
import Box from '@mui/material/Box';
import Typography from '@mui/material/Typography';
import Container from '@mui/material/Container';
import AppRegistrationIcon from '@mui/icons-material/AppRegistration'; // Kayıt ikonu
import CircularProgress from '@mui/material/CircularProgress';
import Checkbox from '@mui/material/Checkbox';
import FormControlLabel from '@mui/material/FormControlLabel';
import Dialog from '@mui/material/Dialog';
import DialogTitle from '@mui/material/DialogTitle';
import DialogContent from '@mui/material/DialogContent';
import DialogActions from '@mui/material/DialogActions';

function RegisterPage() {
    const [formData, setFormData] = useState({
        name: '',
        email: '',
        password: '',
        password2: ''
    });
    const [loading, setLoading] = useState(false);
    
    // KVKK onayları
    const [kvkkConsents, setKvkkConsents] = useState({
        privacyPolicy: false,
        dataProcessing: false,
        marketingConsent: false
    });
    
    // KVKK Modal state
    const [kvkkModalOpen, setKvkkModalOpen] = useState(false);
    const [activeKvkkType, setActiveKvkkType] = useState(null);
    const [kvkkScrolledToBottom, setKvkkScrolledToBottom] = useState(false);
    
    const navigate = useNavigate();
    const { register } = useAuth();
    const { showNotification } = useNotification();

    const { name, email, password, password2 } = formData;

    const onChange = (e) => {
        setFormData((prevState) => ({
            ...prevState,
            [e.target.name]: e.target.value,
        }));
    };

    // KVKK Modal handlers
    const handleKvkkClick = (type) => {
        setActiveKvkkType(type);
        setKvkkScrolledToBottom(false);
        setKvkkModalOpen(true);
    };

    const handleKvkkScroll = (e) => {
        const element = e.target;
        const isAtBottom = element.scrollHeight - element.scrollTop <= element.clientHeight + 50;
        if (isAtBottom && !kvkkScrolledToBottom) {
            setKvkkScrolledToBottom(true);
        }
    };

    const handleKvkkAccept = () => {
        if (!kvkkScrolledToBottom) {
            showNotification('Lütfen metni sonuna kadar okuyun.', 'warning');
            return;
        }
        
        setKvkkConsents(prev => ({
            ...prev,
            [activeKvkkType]: true
        }));
        setKvkkModalOpen(false);
        setActiveKvkkType(null);
        setKvkkScrolledToBottom(false);
    };

    const handleKvkkReject = () => {
        setKvkkConsents(prev => ({
            ...prev,
            [activeKvkkType]: false
        }));
        setKvkkModalOpen(false);
        setActiveKvkkType(null);
        setKvkkScrolledToBottom(false);
    };

    const onSubmit = async (e) => {
        e.preventDefault();

        // Client-Side Doğrulamalar
        if (!name || !email || !password || !password2) {
            showNotification('Lütfen tüm alanları doldurun.', 'error');
            return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            showNotification('Lütfen geçerli bir e-posta adresi girin.', 'error');
            return;
        }
         if (password.length < 6) { // Minimum 6 karakter kontrolü
            showNotification('Şifre en az 6 karakter olmalıdır.', 'error');
            return;
        }
        if (password !== password2) {
            showNotification('Şifreler eşleşmiyor!', 'error');
            return; // setLoading(true) öncesi return
        }
        
        // KVKK onayları kontrolü
        if (!kvkkConsents.privacyPolicy || !kvkkConsents.dataProcessing) {
            showNotification('Kayıt olmak için zorunlu onayları kabul etmelisiniz.', 'error');
            return;
        }

        setLoading(true);

        try {
            await register(name, email, password);
            navigate('/login', { state: { message: 'Kayıt başarılı! Lütfen giriş yapın.' } }); 
        } catch (error) {
            const errorMsg = error.response?.data?.message || error.message || 'Bir hata oluştu';
            // Backend'den gelen yaygın hataları yakala
            if (errorMsg.toLowerCase().includes('email already exists') || errorMsg.toLowerCase().includes('eposta zaten mevcut')) {
                 showNotification('Bu e-posta adresi zaten kayıtlı.', 'error');
            } else {
                 showNotification(`Kayıt başarısız: ${errorMsg}`, 'error');
            }
            console.error('Kayıt hatası:', error);
            setLoading(false); // Hata durumunda loading'i kapat
        } 
        // finally bloğu kaldırıldı, çünkü başarılı durumda navigate oluyor, 
        // hata durumunda ise catch içinde setLoading(false) çağrılıyor.
    };

    return (
        <Container component="main" maxWidth="xs">
            <Box
                sx={{
                    marginTop: 8,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                }}
            >
                <Avatar sx={{ m: 1, bgcolor: 'primary.main' }}> { /* Farklı renk */} 
                    <AppRegistrationIcon />
                </Avatar>
                <Typography component="h1" variant="h5">
                    Kayıt Ol
                </Typography>
                <Box component="form" noValidate onSubmit={onSubmit} sx={{ mt: 3 }}>
                    <Grid container spacing={2}>
                        <Grid item xs={12}>
                            <TextField
                                autoComplete="name"
                                name="name"
                                required
                                fullWidth
                                id="name"
                                label="İsim Soyisim"
                                autoFocus
                                value={name}
                                onChange={onChange}
                                disabled={loading}
                            />
                        </Grid>
                        <Grid item xs={12}>
                            <TextField
                                required
                                fullWidth
                                id="email"
                                label="Email Adresi"
                                name="email"
                                autoComplete="email"
                                value={email}
                                onChange={onChange}
                                disabled={loading}
                            />
                        </Grid>
                        <Grid item xs={12}>
                            <TextField
                                required
                                fullWidth
                                name="password"
                                label="Şifre"
                                type="password"
                                id="password"
                                autoComplete="new-password"
                                value={password}
                                onChange={onChange}
                                disabled={loading}
                            />
                        </Grid>
                         <Grid item xs={12}>
                            <TextField
                                required
                                fullWidth
                                name="password2"
                                label="Şifre Tekrar"
                                type="password"
                                id="password2"
                                autoComplete="new-password"
                                value={password2}
                                onChange={onChange}
                                disabled={loading}
                            />
                        </Grid>
                        
                        {/* KVKK Onayları */}
                        <Grid item xs={12}>
                            <Box 
                                sx={{ 
                                    mt: 1, 
                                    p: 2.5, 
                                    backgroundColor: '#f8f9fa',
                                    borderRadius: 2,
                                    border: '2px solid #e0e0e0'
                                }}
                            >
                                <Typography 
                                    variant="subtitle1" 
                                    sx={{ 
                                        mb: 1.5, 
                                        fontWeight: 600,
                                        color: '#1a1a1a',
                                        fontSize: '1rem'
                                    }}
                                >
                                    Kişisel Verilerin Korunması (KVKK)
                                </Typography>
                                
                                <FormControlLabel
                                    control={
                                        <Checkbox
                                            checked={kvkkConsents.privacyPolicy}
                                            onChange={() => handleKvkkClick('privacyPolicy')}
                                            disabled={loading}
                                            sx={{
                                                color: 'primary.main',
                                                '&.Mui-checked': {
                                                    color: 'primary.main',
                                                },
                                            }}
                                        />
                                    }
                                    label={
                                        <Typography sx={{ fontSize: '0.9rem' }}>
                                            <span style={{ color: '#d32f2f', fontWeight: 600 }}>*</span>{' '}
                                            <strong>Gizlilik Politikası</strong> ve <strong>Kullanım Koşullarını</strong> okudum, kabul ediyorum.
                                        </Typography>
                                    }
                                    sx={{ mb: 1, alignItems: 'flex-start' }}
                                />
                                
                                <FormControlLabel
                                    control={
                                        <Checkbox
                                            checked={kvkkConsents.dataProcessing}
                                            onChange={() => handleKvkkClick('dataProcessing')}
                                            disabled={loading}
                                            sx={{
                                                color: 'primary.main',
                                                '&.Mui-checked': {
                                                    color: 'primary.main',
                                                },
                                            }}
                                        />
                                    }
                                    label={
                                        <Typography sx={{ fontSize: '0.9rem' }}>
                                            <span style={{ color: '#d32f2f', fontWeight: 600 }}>*</span>{' '}
                                            Kişisel verilerimin, <strong>KVKK Aydınlatma Metni</strong> kapsamında işlenmesine ve saklanmasına onay veriyorum.
                                        </Typography>
                                    }
                                    sx={{ mb: 1, alignItems: 'flex-start' }}
                                />
                                
                                <FormControlLabel
                                    control={
                                        <Checkbox
                                            checked={kvkkConsents.marketingConsent}
                                            onChange={(e) => setKvkkConsents(prev => ({ 
                                                ...prev, 
                                                marketingConsent: e.target.checked 
                                            }))}
                                            disabled={loading}
                                            sx={{
                                                color: 'primary.main',
                                                '&.Mui-checked': {
                                                    color: 'primary.main',
                                                },
                                            }}
                                        />
                                    }
                                    label={
                                        <Typography sx={{ fontSize: '0.9rem' }}>
                                            Kampanya, duyuru ve tanıtım amaçlı <strong>ticari elektronik iletiler</strong> almak istiyorum.
                                        </Typography>
                                    }
                                    sx={{ alignItems: 'flex-start' }}
                                />
                            </Box>
                        </Grid>
                    </Grid>
                    <Button
                        type="submit"
                        fullWidth
                        variant="contained"
                        sx={{ mt: 3, mb: 2 }}
                        disabled={loading}
                    >
                        {loading ? <CircularProgress size={24} /> : 'Kayıt Ol'}
                    </Button>
                    <Grid container justifyContent="flex-end">
                        <Grid item>
                            <Link component={RouterLink} to="/login" variant="body2">
                                Zaten hesabınız var mı? Giriş Yapın
                            </Link>
                        </Grid>
                    </Grid>
                </Box>
            </Box>

            {/* KVKK Modal */}
            <Dialog 
                open={kvkkModalOpen} 
                onClose={() => {
                    setKvkkModalOpen(false);
                    setActiveKvkkType(null);
                    setKvkkScrolledToBottom(false);
                }} 
                maxWidth="md" 
                fullWidth
                PaperProps={{
                    sx: {
                        borderRadius: 3,
                        maxHeight: '90vh',
                        backgroundColor: '#ffffff'
                    }
                }}
            >
                <DialogTitle 
                    sx={{ 
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        color: 'white',
                        py: 3,
                        px: 4,
                        fontWeight: 600,
                        fontSize: '1.5rem'
                    }}
                >
                    {activeKvkkType && KVKK_TEXTS[activeKvkkType]?.title}
                </DialogTitle>
                <DialogContent 
                    onScroll={handleKvkkScroll}
                    sx={{ 
                        mt: 3,
                        px: 4,
                        py: 3,
                        backgroundColor: '#fafafa',
                        maxHeight: '60vh',
                        overflowY: 'auto'
                    }}
                >
                    <Typography 
                        component="pre" 
                        sx={{ 
                            whiteSpace: 'pre-wrap',
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                            fontSize: '1rem',
                            lineHeight: 1.8,
                            color: '#1a1a1a',
                            backgroundColor: 'white',
                            padding: 3,
                            borderRadius: 2,
                            border: '1px solid #e0e0e0',
                            margin: 0
                        }}
                    >
                        {activeKvkkType && KVKK_TEXTS[activeKvkkType]?.content}
                    </Typography>
                    
                    {!kvkkScrolledToBottom && (
                        <Box 
                            sx={{ 
                                position: 'sticky',
                                bottom: -24,
                                left: 0,
                                right: 0,
                                py: 3,
                                textAlign: 'center',
                                background: 'linear-gradient(to top, rgba(250, 250, 250, 1) 60%, rgba(250, 250, 250, 0))',
                                pointerEvents: 'none',
                                mt: -8
                            }}
                        >
                            <Typography 
                                variant="caption" 
                                sx={{ 
                                    color: '#667eea',
                                    fontWeight: 700,
                                    fontSize: '1rem',
                                    display: 'inline-block',
                                    px: 3,
                                    py: 1.5,
                                    backgroundColor: 'white',
                                    borderRadius: 3,
                                    boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)',
                                    pointerEvents: 'auto',
                                    border: '2px solid #667eea'
                                }}
                            >
                                ↓ Lütfen metni sonuna kadar okuyun ↓
                            </Typography>
                        </Box>
                    )}
                </DialogContent>
                <DialogActions sx={{ p: 3, gap: 2, flexDirection: { xs: 'column', sm: 'row' }, backgroundColor: '#fafafa' }}>
                    <Button 
                        onClick={handleKvkkReject}
                        variant="outlined"
                        size="large"
                        sx={{
                            borderRadius: 3,
                            px: 5,
                            py: 1.5,
                            textTransform: 'none',
                            fontWeight: 600,
                            fontSize: '1rem',
                            borderWidth: 2,
                            borderColor: '#d32f2f',
                            color: '#d32f2f',
                            minWidth: { xs: '100%', sm: '160px' },
                            backgroundColor: 'white',
                            '&:hover': {
                                borderWidth: 2,
                                backgroundColor: '#ffebee',
                                borderColor: '#c62828',
                                color: '#c62828',
                            }
                        }}
                    >
                        Reddet
                    </Button>
                    <Button 
                        variant="contained"
                        size="large"
                        onClick={handleKvkkAccept}
                        disabled={!kvkkScrolledToBottom}
                        sx={{
                            borderRadius: 3,
                            px: 5,
                            py: 1.5,
                            textTransform: 'none',
                            fontWeight: 600,
                            fontSize: '1rem',
                            minWidth: { xs: '100%', sm: '200px' },
                            background: kvkkScrolledToBottom 
                                ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                : '#cccccc',
                            color: 'white',
                            boxShadow: kvkkScrolledToBottom 
                                ? '0 4px 15px rgba(102, 126, 234, 0.4)'
                                : 'none',
                            '&:hover': {
                                background: kvkkScrolledToBottom 
                                    ? 'linear-gradient(135deg, #5568d3 0%, #6a4190 100%)'
                                    : '#cccccc',
                                boxShadow: kvkkScrolledToBottom 
                                    ? '0 6px 20px rgba(102, 126, 234, 0.6)'
                                    : 'none',
                            },
                            '&:disabled': {
                                background: '#cccccc',
                                color: '#999',
                            }
                        }}
                    >
                        {kvkkScrolledToBottom ? 'Okudum, Kabul Ediyorum ✓' : 'Lütfen Okuyun'}
                    </Button>
                </DialogActions>
            </Dialog>
        </Container>
    );
}

export default RegisterPage; 